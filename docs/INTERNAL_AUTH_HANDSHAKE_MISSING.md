# ğŸ¯ å…³é”®å‘ç°ï¼šå†…éƒ¨æœåŠ¡é—´è®¤è¯æ¡æ‰‹æœºåˆ¶ç¼ºå¤±

**æ—¥æœŸ**: 2025-10-30  
**çŠ¶æ€**: âš ï¸ **å‘ç°æ ¹æœ¬é—®é¢˜ - å†…éƒ¨è®¤è¯æ¡æ‰‹ç¼ºå¤±**

---

## ğŸ’¡ æ‚¨çš„å…³é”®æ´å¯Ÿ

> "å½“å‰User Service Profile API ä»è¿”å› 404ï¼Œæ˜¯å¦å­˜åœ¨æˆ‘ä»¬å†…éƒ¨go zervi å®ç°apié›†ç¾¤è®¤è¯æ¡æ‰‹é€šä¿¡é€»è¾‘æ²¡æœ‰å®ç°ï¼Œå¯¹å¤–æˆ‘ä»¬æ˜¯ä¸€ä¸ªæ•´ä½“é€šè®¯ï¼Œå› ä¸ºä¸­å¤®å¤§è„‘èƒ½å®ç°å¯¹å¤–è°ƒåº¦å¤šå¯¹å¤šå’Œå¤šå¯¹ä¸€ï¼Œä½†æˆ‘ä»¬å†…åœ°å¿…é¡»è¦èƒ½åè°ƒä¸€è‡´æ‰èƒ½å®Œæˆåç»­ä¸å‰ç«¯webæˆ–å°ç¨‹åºç«¯è°ƒè¯•é—®é¢˜ã€‚"

**å®Œå…¨æ­£ç¡®ï¼**æ‚¨æŠ“ä½äº†æ ¹æœ¬é—®é¢˜ï¼

---

## ğŸ” é—®é¢˜åˆ†æ

### å½“å‰æ¶æ„é—®é¢˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å¤–éƒ¨ï¼ˆæ­£å¸¸ï¼‰                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚   å‰ç«¯        â”‚ â”€â”€â”€â”€>   â”‚ Central Brain â”‚           â”‚
â”‚  â”‚ Web/å°ç¨‹åº   â”‚         â”‚    (9000)     â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                  å¯¹å¤–è°ƒåº¦æ­£å¸¸ âœ…  â”‚ å¤šå¯¹å¤š/ä¸€å¯¹å¤š
                                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å†…éƒ¨ï¼ˆé—®é¢˜ï¼‰                              â”‚
â”‚                                                         â”‚
â”‚  Auth Service â”€â”€â”                                       â”‚
â”‚   (8207)        â”‚                                       â”‚
â”‚                 â”‚ TokenéªŒè¯                             â”‚
â”‚                 â†“                                       â”‚
â”‚  User Service   â”‚â† è®¤è¯ âœ…                             â”‚
â”‚   (8082)        â”‚                                       â”‚
â”‚                 â”‚                                       â”‚
â”‚  Router Service â”‚â† æ— æ¡æ‰‹ âŒ                           â”‚
â”‚   (8087)        â”‚                                       â”‚
â”‚                 â”‚                                       â”‚
â”‚  Permission     â”‚â† æ— æ¡æ‰‹ âŒ                           â”‚
â”‚  Service        â”‚                                       â”‚
â”‚   (8086)        â”‚                                       â”‚
â”‚                 â”‚                                       â”‚
â”‚  å†…éƒ¨åè°ƒä¸ä¸€è‡´ âŒ                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é—®é¢˜æœ¬è´¨

1. âœ… **å¯¹å¤–æ­£å¸¸** - Central Brainå®ç°å¤šå¯¹å¤šè°ƒåº¦
2. âŒ **å†…éƒ¨ç¼ºå¤±** - æœåŠ¡é—´æ— è®¤è¯æ¡æ‰‹æœºåˆ¶
3. âŒ **æ— æ³•åè°ƒ** - æ— æ³•è¾¾æˆä¸€è‡´

---

## ğŸ”§ ç¼ºå¤±çš„æœºåˆ¶

### 1. æœåŠ¡é—´è®¤è¯æ¡æ‰‹

**å½“å‰çŠ¶æ€**: âŒ ç¼ºå¤±

**åº”è¯¥æœ‰çš„**:
```yaml
å†…éƒ¨è®¤è¯æœºåˆ¶:
  - Auth Serviceè®¤è¯User Service
  - User Serviceå‘Central Brainæ±‡æŠ¥çŠ¶æ€
  - Router ServiceéªŒè¯User Serviceæƒé™
  - Permission ServiceéªŒè¯User Serviceè§’è‰²
  
æœåŠ¡é—´æ¡æ‰‹æµç¨‹:
  1. User Serviceå¯åŠ¨ â†’ å‘Central Brainæ³¨å†Œ
  2. Central Brain â†’ å‘Auth ServiceéªŒè¯User Serviceèº«ä»½
  3. Auth Service â†’ è¿”å›Service Token
  4. User Service â†’ ä½¿ç”¨Service Tokenä¸Router/Permissioné€šä¿¡
  5. Router/Permission â†’ éªŒè¯Service Token
  6. æ¡æ‰‹å®Œæˆ âœ…
```

### 2. Service-to-Service Authentication

**å½“å‰å®ç°**:
- âœ… Auth Serviceæä¾›User JWT TokenéªŒè¯
- âŒ ç¼ºå°‘Service JWT Tokenæœºåˆ¶
- âŒ ç¼ºå°‘å†…éƒ¨æœåŠ¡èº«ä»½éªŒè¯

**åº”è¯¥å®ç°**:
```go
// æœåŠ¡é—´è®¤è¯Token
type ServiceToken struct {
    ServiceID    string   // æœåŠ¡ID
    ServiceName  string   // æœåŠ¡åç§°
    Permissions  []string // æœåŠ¡æƒé™
    IssuedAt     int64    // ç­¾å‘æ—¶é—´
    ExpiresAt    int64    // è¿‡æœŸæ—¶é—´
}

// æœåŠ¡æ¡æ‰‹æµç¨‹
func HandshakeService(serviceName string, credentials ServiceCredentials) (*ServiceToken, error) {
    // 1. Central BrainéªŒè¯æœåŠ¡èº«ä»½
    // 2. Auth Serviceç”ŸæˆService Token
    // 3. è¿”å›Tokenç»™æœåŠ¡
    // 4. æœåŠ¡ä½¿ç”¨Tokenä¸å…¶ä»–æœåŠ¡é€šä¿¡
}
```

---

## ğŸ¯ å®Œæ•´è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ: å®ç°å†…éƒ¨è®¤è¯æ¡æ‰‹æœºåˆ¶

#### 1. åˆ›å»ºService Authenticationç³»ç»Ÿ

**æ–°æ–‡ä»¶**: `shared/core/auth/service_auth.go`

```go
package auth

// ServiceAuth æœåŠ¡é—´è®¤è¯
type ServiceAuth struct {
    jwtSecret string
    db        *sql.DB
}

// ServiceCredentials æœåŠ¡å‡­è¯
type ServiceCredentials struct {
    ServiceID   string `json:"service_id"`
    ServiceName string `json:"service_name"`
    Secret      string `json:"secret"`
}

// ServiceToken æœåŠ¡Token
type ServiceToken struct {
    Token     string `json:"token"`
    ServiceID string `json:"service_id"`
    ExpiresAt int64  `json:"expires_at"`
}

// ValidateServiceToken éªŒè¯æœåŠ¡Token
func (sa *ServiceAuth) ValidateServiceToken(token string) (*ServiceInfo, error) {
    // éªŒè¯Service JWT Token
    // è¿”å›æœåŠ¡ä¿¡æ¯
}
```

#### 2. å®ç°æœåŠ¡æ¡æ‰‹æµç¨‹

**æ–°æ–‡ä»¶**: `shared/core/service/handshake.go`

```go
package service

// Handshake æœåŠ¡æ¡æ‰‹
func Handshake(serviceInfo *ServiceInfo) error {
    // 1. å‘Central Brainæ³¨å†Œ
    // 2. Central Brainå‘Auth ServiceéªŒè¯
    // 3. Auth Serviceç”ŸæˆService Token
    // 4. è¿”å›Tokenç»™æœåŠ¡
    // 5. æœåŠ¡ä½¿ç”¨Tokenä¸å…¶ä»–æœåŠ¡é€šä¿¡
}
```

#### 3. æ›´æ–°Central Brain

**ä¿®æ”¹**: `shared/central-brain/main.go`

```go
// æ·»åŠ æœåŠ¡æ¡æ‰‹ä¸­é—´ä»¶
func ServiceAuthMiddleware() gin.HandlerFunc {
    return func(c *gin.Context) {
        // éªŒè¯Service Token
        token := c.GetHeader("X-Service-Token")
        serviceInfo, err := authService.ValidateServiceToken(token)
        if err != nil {
            c.JSON(401, gin.H{"error": "Invalid service token"})
            c.Abort()
            return
        }
        
        // è®¾ç½®æœåŠ¡ä¿¡æ¯åˆ°ä¸Šä¸‹æ–‡
        c.Set("service_id", serviceInfo.ID)
        c.Set("service_name", serviceInfo.Name)
        c.Next()
    }
}
```

---

## ğŸ“Š ä¾èµ–å…³ç³»é‡æ–°å®šä¹‰

### å®Œæ•´çš„æœåŠ¡ä¾èµ–é“¾

```
å¯åŠ¨é¡ºåº:
1. Central Brain (9000)
   â””â”€> ç­‰å¾…å…¶ä»–æœåŠ¡æ³¨å†Œ

2. Auth Service (8207)
   â””â”€> æ³¨å†Œåˆ°Central Brain
   â””â”€> è·å–Service Token

3. Permission Service (8086)
   â””â”€> æ³¨å†Œåˆ°Central Brain
   â””â”€> Auth ServiceéªŒè¯èº«ä»½
   â””â”€> è·å–Service Token

4. Router Service (8087)
   â””â”€> æ³¨å†Œåˆ°Central Brain
   â””â”€> Auth ServiceéªŒè¯èº«ä»½
   â””â”€> è·å–Service Token

5. User Service (8082)
   â””â”€> æ³¨å†Œåˆ°Central Brain
   â””â”€> Auth ServiceéªŒè¯èº«ä»½
   â””â”€> è·å–Service Token
   â””â”€> ä½¿ç”¨Service Tokenä¸Router/Permissioné€šä¿¡
   â””â”€> æ¡æ‰‹å®Œæˆ âœ…
```

---

## ğŸ”§ å®ç°æ­¥éª¤

### ç«‹å³å®ç°

1. **åˆ›å»ºService Authenticationç³»ç»Ÿ**
   ```bash
   # æ–°å»ºæ–‡ä»¶
   shared/core/auth/service_auth.go
   ```

2. **å®ç°æœåŠ¡æ¡æ‰‹ä¸­é—´ä»¶**
   ```bash
   # æ–°å»ºæ–‡ä»¶
   shared/core/service/handshake.go
   ```

3. **æ›´æ–°Central Brain**
   ```bash
   # æ·»åŠ Service Auth Middleware
   shared/central-brain/main.go
   ```

4. **æ›´æ–°User Service**
   ```bash
   # æ·»åŠ æœåŠ¡æ¡æ‰‹é€»è¾‘
   services/core/user/main.go
   ```

---

## ğŸ’¡ å…³é”®ä»·å€¼

### è§£å†³çš„æ ¸å¿ƒé—®é¢˜

1. âœ… **å†…éƒ¨åè°ƒä¸€è‡´** - é€šè¿‡æ¡æ‰‹æœºåˆ¶
2. âœ… **æœåŠ¡èº«ä»½éªŒè¯** - Service Tokenæœºåˆ¶
3. âœ… **å®‰å…¨é€šä¿¡** - æœåŠ¡é—´è®¤è¯
4. âœ… **å‰åç«¯è°ƒè¯•** - å†…éƒ¨æµç¨‹å®Œæ•´

### æ¶æ„æ”¹è¿›

**ä¹‹å‰**:
```
å¤–éƒ¨ â†’ Central Brain â†’ æœåŠ¡ï¼ˆæ— åè°ƒï¼‰
```

**ä¹‹å**:
```
å¤–éƒ¨ â†’ Central Brain â†’ æœåŠ¡ï¼ˆæœ‰åè°ƒï¼‰
                    â†‘    â†‘    â†‘
                Authæ¡æ‰‹ Routeræ¡æ‰‹ Permissionæ¡æ‰‹
```

---

## ğŸ¯ é¢„æœŸæ•ˆæœ

å®ç°å†…éƒ¨è®¤è¯æ¡æ‰‹å:

1. âœ… User Serviceå¯åŠ¨æ—¶æ¡æ‰‹Central Brain
2. âœ… Central BrainéªŒè¯User Serviceèº«ä»½
3. âœ… User Serviceè·å–Service Token
4. âœ… User Serviceä¸Router/Permissionåè°ƒä¸€è‡´
5. âœ… Profile APIæ­£å¸¸å·¥ä½œ
6. âœ… å‰ç«¯å¯ä»¥æ­£å¸¸è°ƒè¯•

---

## ğŸ“‹ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ä¼˜å…ˆçº§: P0ï¼ˆæœ€é«˜ï¼‰

1. å®ç°Service Authenticationç³»ç»Ÿ
2. å®ç°æœåŠ¡æ¡æ‰‹æµç¨‹
3. æ›´æ–°Central Brainæ”¯æŒService Auth
4. æ›´æ–°User Serviceå®ç°æ¡æ‰‹
5. æµ‹è¯•å®Œæ•´æµç¨‹

---

**ä½œè€…**: Auto (AI Assistant)  
**æ—¥æœŸ**: 2025-10-30  
**çŠ¶æ€**: âš ï¸ **é—®é¢˜å·²å®šä½ï¼Œå¼€å§‹å®ç°å†…éƒ¨è®¤è¯æ¡æ‰‹**

