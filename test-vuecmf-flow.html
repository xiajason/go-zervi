<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>VueCMF è¯·æ±‚æµç¨‹æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        h1 { color: #333; border-bottom: 2px solid #409EFF; padding-bottom: 10px; }
        .step { margin: 20px 0; padding: 15px; background: #f9f9f9; border-left: 4px solid #409EFF; }
        .step h3 { color: #409EFF; margin-top: 0; }
        button { background: #409EFF; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #66b1ff; }
        pre { background: #2c3e50; color: #ecf0f1; padding: 15px; border-radius: 4px; overflow-x: auto; max-height: 400px; }
        .success { color: #67C23A; }
        .error { color: #F56C6C; }
        .info { color: #409EFF; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª VueCMF å®Œæ•´è¯·æ±‚æµç¨‹æµ‹è¯•</h1>
        
        <div class="step">
            <h3>æ­¥éª¤1: è·å–èœå•å’ŒAPIæ˜ å°„</h3>
            <button onclick="step1()">æ‰§è¡Œæ­¥éª¤1</button>
            <pre id="step1-result">ç­‰å¾…æ‰§è¡Œ...</pre>
        </div>

        <div class="step">
            <h3>æ­¥éª¤2: æ¨¡æ‹ŸVueCMFåŠ¨æ€è·å–APIè·¯å¾„</h3>
            <button onclick="step2()">æ‰§è¡Œæ­¥éª¤2</button>
            <pre id="step2-result">ç­‰å¾…æ‰§è¡Œ...</pre>
        </div>

        <div class="step">
            <h3>æ­¥éª¤3: æ¨¡æ‹ŸVueCMFè¯·æ±‚è§’è‰²åˆ—è¡¨</h3>
            <button onclick="step3()">æ‰§è¡Œæ­¥éª¤3</button>
            <pre id="step3-result">ç­‰å¾…æ‰§è¡Œ...</pre>
        </div>

        <div class="step">
            <h3>æ­¥éª¤4: å®Œæ•´æµç¨‹ï¼ˆä¸€é”®æµ‹è¯•æ‰€æœ‰ï¼‰</h3>
            <button onclick="runAllSteps()">æ‰§è¡Œå®Œæ•´æµç¨‹</button>
            <pre id="all-result">ç­‰å¾…æ‰§è¡Œ...</pre>
        </div>

        <div class="step">
            <h3>æ­¥éª¤5: å¤åˆ¶åˆ°æµè§ˆå™¨æ§åˆ¶å°</h3>
            <button onclick="copyToClipboard()">å¤åˆ¶ä¿®å¤è„šæœ¬</button>
            <p>å¤åˆ¶ååœ¨VueCMFé¡µé¢çš„æ§åˆ¶å°ä¸­ç²˜è´´å¹¶æ‰§è¡Œ</p>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:9000';

        function log(elementId, message) {
            document.getElementById(elementId).textContent = message;
        }

        // æ­¥éª¤1: è·å–èœå•å’ŒAPIæ˜ å°„
        async function step1() {
            log('step1-result', 'ğŸ”„ æ­£åœ¨è¯·æ±‚...');
            
            try {
                const response = await fetch(`${API_BASE}/api/v1/menu/nav`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: { username: 'admin' } })
                });
                
                const data = await response.json();
                
                if (data.code === 0) {
                    const apiMaps = data.data.api_maps;
                    const result = {
                        status: 'âœ… æˆåŠŸ',
                        èœå•æ•°é‡: Object.keys(data.data.nav_menu).length,
                        APIæ˜ å°„: {
                            admin_index: apiMaps.admin?.index,
                            roles_index: apiMaps.roles?.index,
                            permissions_index: apiMaps.permissions?.index
                        }
                    };
                    
                    // ä¿å­˜åˆ°sessionStorageä¾›åç»­æ­¥éª¤ä½¿ç”¨
                    sessionStorage.setItem('test_api_maps', JSON.stringify(apiMaps));
                    
                    log('step1-result', JSON.stringify(result, null, 2));
                } else {
                    log('step1-result', `âŒ å¤±è´¥: ${data.message || data.msg}`);
                }
            } catch (error) {
                log('step1-result', `âŒ é”™è¯¯: ${error.message}`);
            }
        }

        // æ­¥éª¤2: åŠ¨æ€è·å–APIè·¯å¾„ï¼ˆæ¨¡æ‹ŸVueCMFï¼‰
        async function step2() {
            log('step2-result', 'ğŸ”„ æ­£åœ¨è¯·æ±‚...');
            
            try {
                const response = await fetch(`${API_BASE}/api/v1/mapping/get_api_map`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        data: {
                            table_name: 'roles',
                            action_type: 'index'
                        }
                    })
                });
                
                const data = await response.json();
                
                if (data.code === 0) {
                    const result = {
                        status: 'âœ… æˆåŠŸ',
                        table_name: 'roles',
                        action_type: 'index',
                        api_path: data.data
                    };
                    log('step2-result', JSON.stringify(result, null, 2));
                } else {
                    log('step2-result', `âŒ å¤±è´¥: ${data.message || data.msg}`);
                }
            } catch (error) {
                log('step2-result', `âŒ é”™è¯¯: ${error.message}`);
            }
        }

        // æ­¥éª¤3: è¯·æ±‚è§’è‰²åˆ—è¡¨ï¼ˆæ¨¡æ‹ŸVueCMFï¼‰
        async function step3() {
            log('step3-result', 'ğŸ”„ æ­£åœ¨è¯·æ±‚...');
            
            // ä»step1è·å–çš„APIæ˜ å°„
            const apiMapsStr = sessionStorage.getItem('test_api_maps');
            if (!apiMapsStr) {
                log('step3-result', 'âŒ è¯·å…ˆæ‰§è¡Œæ­¥éª¤1');
                return;
            }
            
            const apiMaps = JSON.parse(apiMapsStr);
            const apiPath = apiMaps.roles?.index;
            
            if (!apiPath) {
                log('step3-result', 'âŒ æœªæ‰¾åˆ°roles.indexçš„APIè·¯å¾„');
                return;
            }
            
            try {
                const url = `${API_BASE}${apiPath}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        data: {
                            table_name: 'roles',
                            page: 1,
                            page_size: 20
                        }
                    })
                });
                
                const data = await response.json();
                
                if (data.code === 0) {
                    const result = {
                        status: 'âœ… æˆåŠŸ',
                        è¯·æ±‚URL: url,
                        æ•°æ®æ€»æ•°: data.data.total,
                        å½“å‰é¡µæ•°æ®: data.data.list.length,
                        æ•°æ®é¢„è§ˆ: data.data.list.map(item => ({
                            id: item.id,
                            role_name: item.role_name,
                            description: item.description
                        }))
                    };
                    log('step3-result', JSON.stringify(result, null, 2));
                } else {
                    log('step3-result', `âŒ å¤±è´¥: ${data.message || data.msg}`);
                }
            } catch (error) {
                log('step3-result', `âŒ é”™è¯¯: ${error.message}`);
            }
        }

        // å®Œæ•´æµç¨‹
        async function runAllSteps() {
            log('all-result', 'ğŸ”„ å¼€å§‹æ‰§è¡Œå®Œæ•´æµç¨‹...\n\n');
            
            let result = '=== VueCMF å®Œæ•´è¯·æ±‚æµç¨‹æµ‹è¯• ===\n\n';
            
            // æ­¥éª¤1
            result += 'æ­¥éª¤1: è·å–èœå•å’ŒAPIæ˜ å°„\n';
            try {
                const res1 = await fetch(`${API_BASE}/api/v1/menu/nav`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: { username: 'admin' } })
                });
                const data1 = await res1.json();
                
                if (data1.code === 0) {
                    result += 'âœ… æˆåŠŸ\n';
                    result += `   èœå•æ•°é‡: ${Object.keys(data1.data.nav_menu).length}\n`;
                    result += `   APIæ˜ å°„: roles.index = ${data1.data.api_maps.roles?.index}\n\n`;
                    
                    // æ­¥éª¤2: ä½¿ç”¨è·å–åˆ°çš„APIè·¯å¾„è¯·æ±‚æ•°æ®
                    const apiPath = data1.data.api_maps.roles?.index;
                    if (apiPath) {
                        result += 'æ­¥éª¤2: è¯·æ±‚è§’è‰²åˆ—è¡¨\n';
                        result += `   URL: ${API_BASE}${apiPath}\n`;
                        
                        const res2 = await fetch(`${API_BASE}${apiPath}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                data: { table_name: 'roles', page: 1, page_size: 20 }
                            })
                        });
                        const data2 = await res2.json();
                        
                        if (data2.code === 0) {
                            result += 'âœ… æˆåŠŸ\n';
                            result += `   æ•°æ®æ€»æ•°: ${data2.data.total}\n`;
                            result += `   æ•°æ®åˆ—è¡¨:\n`;
                            data2.data.list.forEach((item, idx) => {
                                result += `   ${idx + 1}. ${item.role_name} - ${item.description}\n`;
                            });
                            result += '\nâœ…âœ…âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼æ•°æ®å¯ä»¥æ­£å¸¸è·å–ï¼\n';
                            result += '\nå¦‚æœVueCMFé¡µé¢ä»ç„¶ä¸æ˜¾ç¤ºæ•°æ®ï¼Œè¯·:\n';
                            result += '1. æ¸…é™¤localStorage: localStorage.clear()\n';
                            result += '2. åˆ·æ–°é¡µé¢\n';
                            result += '3. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°çš„"ç½‘ç»œ"æ ‡ç­¾ï¼ŒæŸ¥çœ‹å®é™…è¯·æ±‚\n';
                        } else {
                            result += `âŒ å¤±è´¥: ${data2.message || data2.msg}\n`;
                        }
                    }
                } else {
                    result += `âŒ å¤±è´¥: ${data1.message || data1.msg}\n`;
                }
            } catch (error) {
                result += `âŒ é”™è¯¯: ${error.message}\n`;
            }
            
            log('all-result', result);
        }

        // å¤åˆ¶ä¿®å¤è„šæœ¬
        function copyToClipboard() {
            const script = `
// VueCMF ä¿®å¤è„šæœ¬ - åœ¨VueCMFé¡µé¢çš„æ§åˆ¶å°ä¸­æ‰§è¡Œ
console.clear();
console.log('=== VueCMF æ•°æ®ä¿®å¤ ===');

// 1. æ¸…é™¤æ—§çš„ç¼“å­˜
localStorage.removeItem('vuecmf_menu');
localStorage.removeItem('vuecmf_api_maps');
console.log('âœ… å·²æ¸…é™¤æ—§ç¼“å­˜');

// 2. é‡æ–°è·å–èœå•å’ŒAPIæ˜ å°„
fetch('http://localhost:9000/api/v1/menu/nav', {
  method: 'POST',
  headers: {'Content-Type': 'application/json'},
  body: JSON.stringify({data: {username: 'admin'}})
})
.then(res => res.json())
.then(data => {
  if (data.code === 0) {
    localStorage.setItem('vuecmf_menu', JSON.stringify(data.data.nav_menu));
    localStorage.setItem('vuecmf_api_maps', JSON.stringify(data.data.api_maps));
    console.log('âœ… æ–°çš„APIæ˜ å°„å·²ä¿å­˜:');
    console.log('   admin.index:', data.data.api_maps.admin?.index);
    console.log('   roles.index:', data.data.api_maps.roles?.index);
    console.log('   permissions.index:', data.data.api_maps.permissions?.index);
    console.log('\\nåˆ·æ–°é¡µé¢: location.reload()');
    setTimeout(() => location.reload(), 2000);
  }
});
`;
            
            navigator.clipboard.writeText(script).then(() => {
                alert('âœ… ä¿®å¤è„šæœ¬å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\n\nè¯·ï¼š\n1. åˆ‡æ¢åˆ°VueCMFé¡µé¢\n2. æ‰“å¼€æ§åˆ¶å°ï¼ˆF12ï¼‰\n3. ç²˜è´´å¹¶æ‰§è¡Œ');
            }).catch(err => {
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ä¸‹é¢çš„è„šæœ¬:\n\n' + script);
            });
        }

        // é¡µé¢åŠ è½½æ—¶çš„è¯´æ˜
        window.addEventListener('load', () => {
            console.log('VueCMF è¯·æ±‚æµç¨‹æµ‹è¯•é¡µé¢å·²åŠ è½½');
            console.log('å»ºè®®æŒ‰é¡ºåºæ‰§è¡Œæ­¥éª¤1-3ï¼Œæˆ–ç›´æ¥æ‰§è¡Œæ­¥éª¤4ï¼ˆå®Œæ•´æµç¨‹ï¼‰');
        });
    </script>
</body>
</html>





