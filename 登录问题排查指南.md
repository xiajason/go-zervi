# ç™»å½•é—®é¢˜æ’æŸ¥æŒ‡å—

## å½“å‰æƒ…å†µ

- âœ… åç«¯æœåŠ¡æ­£å¸¸è¿è¡Œï¼ˆCentral Brain + Auth Serviceï¼‰
- âœ… æ•°æ®åº“è´¦å·æ­£ç¡®ï¼ˆadmin / admin123ï¼‰
- âœ… API æµ‹è¯•æˆåŠŸï¼ˆcurl æµ‹è¯•è¿”å› tokenï¼‰
- âœ… å‰ç«¯é…ç½®æ­£ç¡®ï¼ˆAPI_BASE_URL: http://localhost:9000ï¼‰
- âŒ å‰ç«¯ç™»å½•å¤±è´¥

## ğŸ” é—®é¢˜è¯Šæ–­æ­¥éª¤

### æ­¥éª¤ 1: æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯

è¯·æ‰“å¼€æµè§ˆå™¨çš„**æ§åˆ¶å°ï¼ˆConsoleï¼‰**é€‰é¡¹å¡ï¼ˆä¸æ˜¯ Sources é€‰é¡¹å¡ï¼‰ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯ï¼š

1. åœ¨å¼€å‘è€…å·¥å…·ä¸­ï¼Œç‚¹å‡» **"æ§åˆ¶å°"ï¼ˆConsoleï¼‰** é€‰é¡¹å¡
2. æŸ¥çœ‹æ˜¯å¦æœ‰çº¢è‰²é”™è¯¯ä¿¡æ¯
3. ç‰¹åˆ«å…³æ³¨ï¼š
   - ç½‘ç»œè¯·æ±‚é”™è¯¯ï¼ˆ404, 500, CORS ç­‰ï¼‰
   - JavaScript é”™è¯¯
   - API å“åº”é”™è¯¯

### æ­¥éª¤ 2: æ£€æŸ¥ç½‘ç»œè¯·æ±‚

åˆ‡æ¢åˆ°**ç½‘ç»œï¼ˆNetworkï¼‰**é€‰é¡¹å¡ï¼š

1. ç‚¹å‡» **"ç½‘ç»œ"ï¼ˆNetworkï¼‰** é€‰é¡¹å¡
2. æ¸…ç©ºæ‰€æœ‰è®°å½•
3. å†æ¬¡ç‚¹å‡»"ç™»å½•"æŒ‰é’®
4. æŸ¥æ‰¾ `/api/v1/auth/login` æˆ–ç±»ä¼¼çš„ç™»å½•è¯·æ±‚
5. æ£€æŸ¥ï¼š
   - **çŠ¶æ€ç **ï¼šåº”è¯¥æ˜¯ 200
   - **è¯·æ±‚æ•°æ®**ï¼šç¡®è®¤å‘é€çš„ç”¨æˆ·åå’Œå¯†ç 
   - **å“åº”æ•°æ®**ï¼šæŸ¥çœ‹è¿”å›çš„å†…å®¹

### æ­¥éª¤ 3: æ¸…é™¤æµè§ˆå™¨ç¼“å­˜å’Œ LocalStorage

å¯èƒ½æ˜¯æ—§çš„ token æˆ–æ•°æ®å¯¼è‡´é—®é¢˜ï¼š

```javascript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œ
localStorage.clear()
sessionStorage.clear()
location.reload()
```

### æ­¥éª¤ 4: æŸ¥çœ‹å…·ä½“é”™è¯¯ä¿¡æ¯

åœ¨æ§åˆ¶å°ä¸­è¾“å…¥ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹ç¯å¢ƒé…ç½®ï¼š

```javascript
// æ£€æŸ¥ API åŸºç¡€ URL
console.log(import.meta.env.VITE_APP_BASE_API)
// åº”è¯¥è¾“å‡º: http://localhost:9000

// æ£€æŸ¥ localStorage
console.log(localStorage)
```

## ğŸ› ï¸ å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### é—®é¢˜ 1: CORS è·¨åŸŸé”™è¯¯

**ç—‡çŠ¶**ï¼š
```
Access to XMLHttpRequest at 'http://localhost:9000/api/v1/auth/login' from origin 'http://localhost:8081' has been blocked by CORS policy
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
æ£€æŸ¥ Central Brain æ˜¯å¦æ­£ç¡®é…ç½®äº† CORSï¼š

```bash
# æµ‹è¯• CORS
curl -X OPTIONS http://localhost:9000/api/v1/auth/login \
  -H "Origin: http://localhost:8081" \
  -H "Access-Control-Request-Method: POST" \
  -v
```

### é—®é¢˜ 2: API æ˜ å°„ä¸å­˜åœ¨

**ç—‡çŠ¶**ï¼š
```
API æ˜ å°„ä¸å­˜åœ¨: user.login
API æ˜ å°„ä¸å­˜åœ¨: admin.login
```

**åŸå› **ï¼šå‰ç«¯ä½¿ç”¨ VueCMF çš„ API æ˜ å°„æœºåˆ¶ï¼Œéœ€è¦åœ¨æ•°æ®åº“ä¸­é…ç½®

**è§£å†³æ–¹æ¡ˆ**ï¼š

```bash
# æ£€æŸ¥ API æ˜ å°„
PGPASSWORD=vuecmf psql -h localhost -U vuecmf -d zervigo_mvp -c "SELECT * FROM vuecmf_api_map WHERE api_path LIKE '%login%';"
```

### é—®é¢˜ 3: å‰ç«¯ä½¿ç”¨äº†é”™è¯¯çš„ç™»å½•æ¥å£

VueCMF å‰ç«¯å¯èƒ½ä½¿ç”¨ç‰¹å®šçš„ API è·¯å¾„æ ¼å¼ã€‚

**æ£€æŸ¥å‰ç«¯ä»£ç **ï¼š
```bash
grep -r "login" /Users/szjason72/vuecmf/vuecmf-web-master/src/model 2>/dev/null | head -10
```

### é—®é¢˜ 4: Token æ ¼å¼é—®é¢˜

**ç—‡çŠ¶**ï¼šç™»å½•æˆåŠŸä½†æ— æ³•è®¿é—®å…¶ä»–æ¥å£

**è§£å†³æ–¹æ¡ˆ**ï¼š
```javascript
// åœ¨æ§åˆ¶å°æ£€æŸ¥ token
const token = localStorage.getItem('token')
console.log('Token:', token)

// æ£€æŸ¥ token æ ¼å¼ï¼ˆåº”è¯¥æ˜¯ JWTï¼‰
if (token) {
  const parts = token.split('.')
  console.log('Token parts:', parts.length) // åº”è¯¥æ˜¯ 3
}
```

## ğŸ“ è°ƒè¯•å‘½ä»¤

### 1. åç«¯æµ‹è¯•ç™»å½•

```bash
# æµ‹è¯•ç™»å½• APIï¼ˆå·²éªŒè¯æˆåŠŸï¼‰
curl -X POST http://localhost:9000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}' \
  | jq .
```

### 2. æµ‹è¯• VueCMF API æ˜ å°„

```bash
# æµ‹è¯• API æ˜ å°„æŸ¥è¯¢
curl -X POST http://localhost:9000/api/v1/mapping/get_api_map \
  -H "Content-Type: application/json" \
  -d '{"table_name":"admin","action_type":"login"}' \
  | jq .
```

### 3. æŸ¥çœ‹ VueCMF æ˜ å°„é…ç½®

```bash
PGPASSWORD=vuecmf psql -h localhost -U vuecmf -d zervigo_mvp <<EOF
SELECT table_name, action_type, api_path, request_method 
FROM vuecmf_api_map 
WHERE table_name IN ('admin', 'user') 
  AND action_type IN ('login', 'index');
EOF
```

## ğŸ”§ ç´§æ€¥ä¿®å¤æ–¹æ¡ˆ

å¦‚æœæ˜¯ VueCMF API æ˜ å°„é—®é¢˜ï¼Œéœ€è¦æ·»åŠ ç™»å½•æ¥å£æ˜ å°„ï¼š

```sql
-- æ·»åŠ ç™»å½• API æ˜ å°„
INSERT INTO vuecmf_api_map (table_name, action_type, api_path, request_method, note)
VALUES 
    ('admin', 'login', '/api/v1/auth/login', 'POST', 'ç®¡ç†å‘˜ç™»å½•'),
    ('user', 'login', '/api/v1/auth/login', 'POST', 'ç”¨æˆ·ç™»å½•')
ON CONFLICT (table_name, action_type) 
DO UPDATE SET 
    api_path = EXCLUDED.api_path,
    request_method = EXCLUDED.request_method;
```

## ğŸ“Š å®Œæ•´è¯Šæ–­æµç¨‹

```mermaid
graph TD
    A[ç™»å½•å¤±è´¥] --> B{æ£€æŸ¥æ§åˆ¶å°}
    B -->|æœ‰é”™è¯¯| C[æŸ¥çœ‹é”™è¯¯ç±»å‹]
    B -->|æ— é”™è¯¯| D{æ£€æŸ¥ç½‘ç»œè¯·æ±‚}
    
    C -->|CORSé”™è¯¯| E[æ£€æŸ¥CORSé…ç½®]
    C -->|404é”™è¯¯| F[æ£€æŸ¥APIè·¯å¾„]
    C -->|500é”™è¯¯| G[æ£€æŸ¥åç«¯æ—¥å¿—]
    
    D -->|è¯·æ±‚æœªå‘é€| H[æ£€æŸ¥å‰ç«¯ä»£ç ]
    D -->|è¯·æ±‚å¤±è´¥| I[æ£€æŸ¥å“åº”å†…å®¹]
    
    F --> J[å¯èƒ½æ˜¯APIæ˜ å°„é—®é¢˜]
    I --> J
    
    J --> K[æ·»åŠ APIæ˜ å°„]
```

## ğŸ¯ ä¸‹ä¸€æ­¥æ“ä½œ

1. **æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°çš„ Console é€‰é¡¹å¡**
2. **å†æ¬¡å°è¯•ç™»å½•**
3. **è®°å½•æ‰€æœ‰é”™è¯¯ä¿¡æ¯**
4. **å‘Šè¯‰æˆ‘æ§åˆ¶å°æ˜¾ç¤ºçš„é”™è¯¯**

ç„¶åæˆ‘å¯ä»¥é’ˆå¯¹å…·ä½“é”™è¯¯æä¾›è§£å†³æ–¹æ¡ˆã€‚

## ğŸ“ éœ€è¦çš„ä¿¡æ¯

è¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

1. **æ§åˆ¶å°é”™è¯¯ä¿¡æ¯**ï¼ˆçº¢è‰²çš„é”™è¯¯ï¼‰
2. **ç½‘ç»œè¯·æ±‚è¯¦æƒ…**ï¼š
   - è¯·æ±‚ URL
   - è¯·æ±‚æ–¹æ³•ï¼ˆPOST/GETï¼‰
   - çŠ¶æ€ç ï¼ˆ200/404/500 ç­‰ï¼‰
   - å“åº”å†…å®¹
3. **æ˜¯å¦æ˜¾ç¤ºä»»ä½•æç¤ºä¿¡æ¯**ï¼ˆæˆåŠŸ/å¤±è´¥æç¤ºï¼‰

---

## ğŸš€ å¿«é€Ÿæµ‹è¯•

åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œä»¥ä¸‹ä»£ç ï¼Œç›´æ¥æµ‹è¯•ç™»å½•ï¼š

```javascript
fetch('http://localhost:9000/api/v1/auth/login', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    username: 'admin',
    password: 'admin123'
  })
})
.then(res => res.json())
.then(data => {
  console.log('ç™»å½•ç»“æœ:', data);
  if (data.code === 0) {
    console.log('âœ… ç™»å½•æˆåŠŸï¼');
    console.log('Token:', data.data.accessToken);
  } else {
    console.log('âŒ ç™»å½•å¤±è´¥:', data.message);
  }
})
.catch(err => {
  console.error('âŒ è¯·æ±‚å¤±è´¥:', err);
});
```

è¿™å°†ç›´æ¥åœ¨æµè§ˆå™¨ä¸­æµ‹è¯•ç™»å½•ï¼Œç»•è¿‡å‰ç«¯æ¡†æ¶çš„é€»è¾‘ã€‚

