# 📊 中央大脑监控功能使用说明

## 🎯 监控能力总结

### ✅ 中央大脑可以监控的

| 内容 | 监控方式 | 实时性 | 详细程度 |
|------|---------|--------|---------|
| **HTTP API 请求** | 中间件拦截 | ✅ 实时 | ⭐⭐⭐⭐⭐ |
| **响应时间** | 时间戳计算 | ✅ 实时 | 毫秒级 |
| **成功/失败率** | 状态码统计 | ✅ 实时 | 百分比 |
| **服务健康状态** | 熔断器监控 | ✅ 实时 | 服务级 |
| **请求来源** | IP + UserAgent | ✅ 实时 | 客户端级 |
| **用户行为** | Token解析 | ✅ 实时 | 用户级 |

### ⚠️ 中央大脑默认不监控的（但可以增强）

| 内容 | 原因 | 解决方案 |
|------|------|---------|
| **前端路由跳转** | 无HTTP请求 | 前端埋点上报 |
| **页面停留时间** | 浏览器内部 | 心跳机制 |
| **前端性能** | 客户端行为 | Performance API上报 |
| **用户点击** | 前端事件 | 事件埋点 |

## 🔍 实时监控演示

### 场景: 用户完整操作流程

```
用户: 张三
时间: 2024-11-06 09:53:00 - 09:53:30
操作: 登录 → 查看用户列表 → 编辑用户 → 保存
```

### 中央大脑监控记录

```
[09:53:00.123] INFO: {
  "trace_id": "uuid-001",
  "method": "POST",
  "path": "/api/v1/auth/login",
  "remote_addr": "127.0.0.1",
  "user_agent": "Mozilla/5.0 (Macintosh...)",
  "status_code": 200,
  "duration_ms": 23,
  "request_size": 58,
  "response_size": 256
}
✅ 监控到: 用户登录

[09:53:00.456] INFO: {
  "trace_id": "uuid-002",
  "method": "GET",
  "path": "/api/v1/menu/list",
  "remote_addr": "127.0.0.1",
  "status_code": 200,
  "duration_ms": 15,
  "response_size": 512
}
✅ 监控到: 菜单加载

[09:53:10.789] INFO: {
  "trace_id": "uuid-003",
  "method": "GET",
  "path": "/api/v1/admin/index",
  "remote_addr": "127.0.0.1",
  "query": "page=1&pageSize=20",
  "status_code": 200,
  "duration_ms": 25,
  "response_size": 2048
}
✅ 监控到: 查看用户列表

[09:53:25.012] INFO: {
  "trace_id": "uuid-004",
  "method": "POST",
  "path": "/api/v1/admin/save",
  "remote_addr": "127.0.0.1",
  "status_code": 200,
  "duration_ms": 18,
  "request_size": 128,
  "response_size": 64
}
✅ 监控到: 保存用户数据
```

### 统计结果

```
时间段: 09:53:00 - 09:53:30 (30秒)
总请求: 4次
成功率: 100%
平均响应时间: 20.25ms
```

## 📊 查看监控数据的方法

### 方法1: API 查询（实时）

```bash
# 获取实时指标
curl http://localhost:9000/api/v1/metrics | jq .

# 获取熔断器状态
curl http://localhost:9000/api/v1/circuit-breakers | jq .
```

### 方法2: 管理后台页面（可视化）

**步骤**:
1. 添加监控菜单到数据库
2. 访问监控页面
3. 实时查看图表和统计

**新增菜单配置**:
```sql
INSERT INTO vuecmf_menu (pid, title, path, icon, component_path, sort_num, status) VALUES
(0, '系统监控', '/monitoring', 'Monitor', 'Monitoring', 99, 10);
```

**路由配置**:
```typescript
// router/index.ts
{
  path: 'monitoring',
  name: 'Monitoring',
  component: () => import('../views/Monitoring.vue'),
  meta: { title: '系统监控', requiresAuth: true }
}
```

### 方法3: 日志文件（持久化）

```bash
# 实时查看日志
tail -f logs/central_brain.log

# 过滤用户操作
grep "admin" logs/central_brain.log

# 统计请求数
grep "INFO" logs/central_brain.log | wc -l
```

## 🎯 监控的实际应用场景

### 场景1: 性能调优

**发现问题**:
```
监控发现: /api/v1/admin/index 平均响应 180ms (慢)
```

**分析**:
```bash
# 查看详细日志
grep "/api/v1/admin/index" central_brain.log | tail -20

# 发现: 数据库查询占用 150ms
```

**优化**:
```sql
-- 添加索引
CREATE INDEX idx_users_status ON zervigo_auth_users(status);

-- 优化后: 180ms → 25ms (86% 改善)
```

### 场景2: 故障定位

**用户反馈**: "点击角色管理报错"

**排查**:
```bash
# 1. 查看最近的错误日志
grep "ERROR" central_brain.log | tail -10

# 2. 发现
ERROR: {
  "path": "/api/v1/roles/index",
  "status_code": 500,
  "error": "database connection failed"
}

# 3. 定位问题: 数据库连接断开
# 4. 修复: 重启数据库
```

### 场景3: 容量规划

**监控数据显示**:
```
日期: 2024-11-01 ~ 2024-11-06
总请求: 250,000
日均请求: 50,000
峰值QPS: 150
平均响应: 35ms

预测: 下月用户增长 50%
需要容量: 75,000请求/天, 峰值QPS 225

建议: 
├─ 当前配置支持 200 QPS
├─ 余量充足
└─ 无需扩容
```

## 💡 增强监控的建议

### 短期（立即实施）

#### 1. 添加前端埋点

```typescript
// src/router/index.ts
router.afterEach((to, from) => {
  // 记录页面跳转
  request.post('/api/v1/tracking/page-view', {
    from_path: from.path,
    to_path: to.path,
    timestamp: Date.now()
  }).catch(() => {}) // 埋点失败不影响用户
})
```

#### 2. 添加性能监控

```typescript
// src/main.ts
router.afterEach((to) => {
  nextTick(() => {
    const loadTime = performance.now()
    
    request.post('/api/v1/tracking/performance', {
      page: to.path,
      load_time_ms: Math.round(loadTime)
    }).catch(() => {})
  })
})
```

### 中期（1-2周）

#### 3. 添加用户行为追踪

```typescript
// 追踪用户点击
document.addEventListener('click', (e) => {
  const target = e.target as HTMLElement
  
  request.post('/api/v1/tracking/click', {
    element: target.tagName,
    text: target.innerText,
    page: router.currentRoute.value.path
  }).catch(() => {})
})
```

#### 4. 添加错误监控

```typescript
// 捕获前端错误
window.addEventListener('error', (e) => {
  request.post('/api/v1/tracking/error', {
    message: e.message,
    stack: e.error?.stack,
    page: router.currentRoute.value.path
  }).catch(() => {})
})
```

### 长期（1-2月）

#### 5. 集成专业监控工具

- **Prometheus** - 指标采集
- **Grafana** - 可视化仪表盘
- **ELK** - 日志分析
- **Sentry** - 错误追踪

## 🎯 总结

### 当前监控能力

```
前端页面跳转:
├─ 纯路由跳转 (如: /home → /system/users)
│  └─ 中央大脑: ❌ 默认不监控（可通过埋点实现）
│
└─ 数据加载 (如: 加载用户列表)
   └─ 中央大脑: ✅ 100%实时监控
      ├─ 请求日志 (RequestLogger)
      ├─ 性能指标 (Metrics)
      ├─ 限流检查 (RateLimiter)
      └─ 熔断监控 (CircuitBreaker)
```

### 监控的价值

1. **故障快速定位** - 通过日志和指标快速找到问题
2. **性能持续优化** - 基于数据驱动的优化决策
3. **用户体验提升** - 识别慢接口并优化
4. **容量规划** - 基于真实数据做容量评估
5. **安全防护** - 通过限流和熔断保护系统

**中央大脑的监控能力确保了系统的高可用和高性能！** 🎉

---

**文档版本**: v1.0  
**创建日期**: 2024-11-06  
**核心结论**: 中央大脑实时监控所有API请求，确保系统稳定高效运行  

