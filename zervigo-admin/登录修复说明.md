# ğŸ”§ ç™»å½•åŠŸèƒ½ä¿®å¤è¯´æ˜

## âŒ é—®é¢˜æè¿°

ç”¨æˆ·ç™»å½•æ—¶æç¤ºï¼š**"ç™»å½•å“åº”æ ¼å¼é”™è¯¯"**

## ğŸ” é—®é¢˜æ ¹æœ¬åŸå› 

### å“åº”æ•°æ®è§£åŒ…æ··ä¹±

åç«¯å“åº”ç»è¿‡äº†**ä¸¤æ¬¡è§£åŒ…**ï¼Œå¯¼è‡´æ•°æ®è®¿é—®è·¯å¾„é”™è¯¯ï¼š

```
1. åç«¯è¿”å›åŸå§‹æ•°æ®
   â†“
2. axios æ¥æ”¶: response.data
   â†“
3. request.ts æ‹¦æˆªå™¨: return res.data  (ç¬¬ä¸€æ¬¡è§£åŒ…)
   â†“
4. Login.vue æ¥æ”¶: res
   â†“
5. é”™è¯¯è®¿é—®: res.data.token  âŒ (undefined)
   æ­£ç¡®è®¿é—®: res.token        âœ…
```

## âœ… å·²ä¿®å¤çš„å†…å®¹

### 1. ä¿®å¤ request.ts å“åº”æ‹¦æˆªå™¨

**ä¿®å¤å†…å®¹**: å…¼å®¹å¤šç§åç«¯å“åº”æ ¼å¼

```typescript
request.interceptors.response.use(
  (response) => {
    const res = response.data
    
    // å…¼å®¹å¤šç§æ ¼å¼ï¼š
    // - {status: "success", data: {}, message: ""} - Zervigo
    // - {code: 0, data: {}, message: ""} - VueCMF
    // - {code: 200, data: {}, msg: ""} - å…¶ä»–
    
    const isSuccess = 
      res.code === 0 || 
      res.code === 200 || 
      res.status === 'success' || 
      res.success === true
    
    if (isSuccess) {
      return res.data || res  // è¿”å› data éƒ¨åˆ†ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿”å›æ•´ä¸ªå“åº”
    } else {
      ElMessage.error(res.message || res.msg || 'è¯·æ±‚å¤±è´¥')
      return Promise.reject(new Error(res.message))
    }
  }
)
```

### 2. ä¿®å¤ Login.vue å“åº”å¤„ç†

**ä¿®å¤å‰** (é”™è¯¯):
```typescript
const res = await login(loginForm)

if (res.data && res.data.token) {  // âŒ é”™è¯¯ï¼šres.data.token æ˜¯ undefined
  localStorage.setItem('token', res.data.token)
  ...
}
```

**ä¿®å¤å** (æ­£ç¡®):
```typescript
const res = await login(loginForm)

console.log('ç™»å½•å“åº”:', res)  // æ·»åŠ è°ƒè¯•æ—¥å¿—

// request.ts å·²è¿”å› res.dataï¼Œæ‰€ä»¥ç›´æ¥è®¿é—® res.token
if (res && res.token) {  // âœ… æ­£ç¡®
  localStorage.setItem('token', res.token)
  localStorage.setItem('userInfo', JSON.stringify(res.user || { username: loginForm.username }))
  
  ElMessage.success('ç™»å½•æˆåŠŸï¼')
  router.push('/home')
} else {
  console.error('ç™»å½•å“åº”æ ¼å¼é”™è¯¯:', res)
  ElMessage.error('ç™»å½•å“åº”æ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡')
}
```

## ğŸ“Š æ•°æ®æµè½¬è¯¦è§£

### å®Œæ•´çš„æ•°æ®æµè½¬è¿‡ç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. åç«¯ Auth Service è¿”å›           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ {                                   â”‚
â”‚   "status": "success",              â”‚
â”‚   "data": {                         â”‚
â”‚     "token": "eyJhbGci...",         â”‚
â”‚     "user": {                       â”‚
â”‚       "id": 1,                      â”‚
â”‚       "username": "admin"           â”‚
â”‚     }                               â”‚
â”‚   },                                â”‚
â”‚   "message": "Login successful"    â”‚
â”‚ }                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Central Brain ä»£ç†è½¬å‘           â”‚
â”‚    (ä¸æ”¹å˜æ ¼å¼ï¼Œç›´æ¥è½¬å‘)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Axios æ¥æ”¶                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ response.data = {                   â”‚
â”‚   "status": "success",              â”‚
â”‚   "data": { token: "...", user...}, â”‚
â”‚   "message": "Login successful"    â”‚
â”‚ }                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. request.ts å“åº”æ‹¦æˆªå™¨            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ const res = response.data           â”‚
â”‚ // res.status === 'success' âœ…      â”‚
â”‚ return res.data  // è¿”å›dataå­—æ®µ    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Login.vue æ¥æ”¶                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ const res = await login(...)        â”‚
â”‚ // res = {                          â”‚
â”‚ //   token: "...",                  â”‚
â”‚ //   user: {...}                    â”‚
â”‚ // }                                â”‚
â”‚                                     â”‚
â”‚ âœ… æ­£ç¡®: res.token                  â”‚
â”‚ âŒ é”™è¯¯: res.data.token (undefined) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ› é”™è¯¯æ¡ˆä¾‹åˆ†æ

### é”™è¯¯ä»£ç ç¤ºä¾‹

```typescript
// âŒ é”™è¯¯ç¤ºä¾‹ 1ï¼šé‡å¤è®¿é—® data
const res = await login(...)
if (res.data && res.data.token) {  // res.data æ˜¯ undefined
  ...
}

// âŒ é”™è¯¯ç¤ºä¾‹ 2ï¼šä¸æ£€æŸ¥å­˜åœ¨æ€§
const res = await login(...)
localStorage.setItem('token', res.token)  // å¦‚æœ res æ˜¯ null ä¼šæŠ¥é”™

// âœ… æ­£ç¡®ç¤ºä¾‹ï¼š
const res = await login(...)
if (res && res.token) {
  localStorage.setItem('token', res.token)
  localStorage.setItem('userInfo', JSON.stringify(res.user || {}))
}
```

## ğŸ’¡ è°ƒè¯•æ–¹æ³•

### 1. æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—

ç™»å½•æ—¶ä¼šè¾“å‡ºï¼š
```javascript
ç™»å½•å“åº”: { token: "...", user: {...} }
```

å¦‚æœæ ¼å¼é”™è¯¯ï¼š
```javascript
ç™»å½•å“åº”æ ¼å¼é”™è¯¯: null  // æˆ–å…¶ä»–éé¢„æœŸå€¼
```

### 2. æŸ¥çœ‹Networkè¯·æ±‚

1. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰
2. åˆ‡æ¢åˆ° Network æ ‡ç­¾
3. ç‚¹å‡»ç™»å½•æŒ‰é’®
4. æ‰¾åˆ° `login` è¯·æ±‚
5. æŸ¥çœ‹ Response æ ‡ç­¾ï¼Œçœ‹åŸå§‹å“åº”

### 3. ä½¿ç”¨ curl æµ‹è¯•

```bash
curl -X POST http://localhost:9000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}' \
  | jq .
```

## ğŸ¯ åç«¯å“åº”æ ¼å¼å‚è€ƒ

### æˆåŠŸå“åº”

```json
{
  "status": "success",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoxLCJ1c2VybmFtZSI6ImFkbWluIiwicm9sZSI6InN1cGVyX2FkbWluIiwiZXhwIjoxNzMwOTcyNDAwfQ.xxx",
    "user": {
      "id": 1,
      "username": "admin",
      "email": "admin@zervigo.com",
      "role": "super_admin"
    }
  },
  "message": "Login successful"
}
```

### å¤±è´¥å“åº”

```json
{
  "status": "error",
  "message": "Invalid credentials",
  "error": "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯"
}
```

## ğŸ“ ä¿®å¤éªŒè¯

### æµ‹è¯•æ­¥éª¤

1. **å¯åŠ¨åç«¯**
   ```bash
   cd /Users/szjason72/gozervi/zervigo.demo/shared/central-brain
   go run .
   ```

2. **é‡å¯å‰ç«¯** (å¦‚æœå·²å¯åŠ¨ï¼Œå…ˆ Ctrl+C åœæ­¢)
   ```bash
   cd /Users/szjason72/gozervi/zervigo.demo/zervigo-admin
   npm run dev
   ```

3. **è®¿é—®ç™»å½•é¡µ**
   - æ‰“å¼€ http://localhost:3000
   - æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰

4. **å°è¯•ç™»å½•**
   - ç”¨æˆ·å: `admin`
   - å¯†ç : `admin123`
   - ç‚¹å‡»ç™»å½•

5. **æŸ¥çœ‹æ§åˆ¶å°**
   - åº”è¯¥çœ‹åˆ°: `ç™»å½•å“åº”: { token: "...", user: {...} }`
   - åº”è¯¥æç¤º: `ç™»å½•æˆåŠŸï¼`
   - åº”è¯¥è·³è½¬åˆ°é¦–é¡µ

### é¢„æœŸç»“æœ

âœ… **æˆåŠŸç™»å½•**
- æ§åˆ¶å°è¾“å‡ºç™»å½•å“åº”
- æç¤º"ç™»å½•æˆåŠŸï¼"
- è·³è½¬åˆ° `/home`
- LocalStorage ä¸­ä¿å­˜äº† token å’Œ userInfo

âŒ **ç™»å½•å¤±è´¥**
- æ§åˆ¶å°è¾“å‡ºé”™è¯¯ä¿¡æ¯
- æç¤ºå…·ä½“çš„é”™è¯¯æ¶ˆæ¯
- ç•™åœ¨ç™»å½•é¡µ

## ğŸ”„ å…¼å®¹æ€§è¯´æ˜

ç°åœ¨çš„ `request.ts` å…¼å®¹ä»¥ä¸‹æ‰€æœ‰æ ¼å¼ï¼š

| æ ¼å¼ | åˆ¤æ–­æ¡ä»¶ | æ¥æº |
|------|---------|------|
| `{code: 0, ...}` | `res.code === 0` | VueCMF |
| `{code: 200, ...}` | `res.code === 200` | HTTPæ ‡å‡† |
| `{status: "success", ...}` | `res.status === 'success'` | Zervigo |
| `{success: true, ...}` | `res.success === true` | å…¶ä»– |

---

**ä¿®å¤æ—¥æœŸ**: 2024-11-06  
**ä¿®å¤ç‰ˆæœ¬**: v2.1.2  
**ä¿®å¤å†…å®¹**: 
- âœ… å“åº”æ‹¦æˆªå™¨å…¼å®¹å¤šç§æ ¼å¼
- âœ… Login.vue æ­£ç¡®è®¿é—®å“åº”æ•°æ®
- âœ… æ·»åŠ è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—

