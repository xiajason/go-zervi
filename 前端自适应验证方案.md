# ğŸ¯ å‰ç«¯è‡ªé€‚åº”éªŒè¯æ–¹æ¡ˆ

## ğŸ’¡ æ ¸å¿ƒè®¾è®¡ç†å¿µ

### æ‚¨çš„å…³é”®é—®é¢˜
> "å‰ç«¯æ˜¯å¦èƒ½æŒ‰ç…§P2ä¸šåŠ¡æœåŠ¡çš„ä¸ƒç§ç»„åˆæ–¹å¼ï¼Œæ ¹æ®æ¥å…¥çš„æœåŠ¡ç±»å‹çš„å˜åŒ–ï¼Œè¿›è¡Œè‡ªé€‚åº”ï¼Ÿå› ä¸ºå‰ç«¯å®ƒæœ‰commonç»„ä»¶ã€‚"

### ç­”æ¡ˆï¼šå®Œå…¨å¯ä»¥ï¼âœ…

## ğŸ—ï¸ è‡ªé€‚åº”çš„ä¸‰å±‚æœºåˆ¶

### ç¬¬ä¸€å±‚ï¼šConsulæœåŠ¡å‘ç°
```
Consulç»´æŠ¤å®æ—¶æœåŠ¡çŠ¶æ€ï¼š
  â€¢ job-service: healthy/not found
  â€¢ resume-service: healthy/not found
  â€¢ company-service: healthy/not found

å®æ—¶æ›´æ–°ï¼Œ30ç§’åˆ·æ–°ä¸€æ¬¡
```

### ç¬¬äºŒå±‚ï¼šRouter Serviceæ™ºèƒ½è¿‡æ»¤
```
å·²å®ç°ï¼šservice_discovery.go

åŠŸèƒ½ï¼š
  1. æŸ¥è¯¢Consulè·å–å¯ç”¨æœåŠ¡
  2. ä»æ•°æ®åº“è·å–è·¯ç”±é…ç½®
  3. æ™ºèƒ½è¿‡æ»¤ï¼šWHERE service_name = ANY(å¯ç”¨æœåŠ¡)
  4. è¿”å›ç»™å‰ç«¯

ç»“æœï¼š
  å‰ç«¯åªä¼šæ”¶åˆ°"å½“å‰å¯ç”¨"çš„è·¯ç”±ï¼
```

### ç¬¬ä¸‰å±‚ï¼šå‰ç«¯Commonç»„ä»¶è‡ªåŠ¨é€‚é…
```
Common.vueçš„è®¾è®¡ç²¾é«“ï¼š
  â€¢ é€šè¿‡route.metaè·å–é…ç½®
  â€¢ table_nameé©±åŠ¨ä¸šåŠ¡é€»è¾‘
  â€¢ ä¸€ä¸ªç»„ä»¶é€‚é…æ‰€æœ‰ä¸šåŠ¡ç±»å‹

æ— è®ºæ˜¯Jobã€Resumeè¿˜æ˜¯Companyï¼Œéƒ½èƒ½è‡ªåŠ¨é€‚é…ï¼
```

## ğŸ§ª éªŒè¯åœºæ™¯

### åœºæ™¯1ï¼šåªå¯åŠ¨Job Service

**åç«¯å¯åŠ¨ï¼š**
```bash
# P0 + P1
âœ… Auth, Central Brain
âœ… Router, Permission, User

# P2 åªå¯åŠ¨Job
âœ… Job Service (8084)
âŒ Resume Service - æœªå¯åŠ¨
âŒ Company Service - æœªå¯åŠ¨
```

**Router Serviceçš„æ™ºèƒ½è¿‡æ»¤ï¼š**
```
1. æŸ¥è¯¢Consul
   â†’ å‘ç°ï¼šjob-service = healthy
   â†’ æœªå‘ç°ï¼šresume-service, company-service

2. è¿‡æ»¤è·¯ç”±
   WHERE service_name = 'job-service'
   
3. è¿”å›ç»™å‰ç«¯
   âœ… Jobç›¸å…³çš„è·¯ç”±
   âŒ Resumeç›¸å…³çš„è·¯ç”±ï¼ˆè¿‡æ»¤æ‰ï¼‰
   âŒ Companyç›¸å…³çš„è·¯ç”±ï¼ˆè¿‡æ»¤æ‰ï¼‰
```

**å‰ç«¯è‡ªåŠ¨é€‚é…ï¼š**
```
å‰ç«¯è°ƒç”¨ï¼šGET /api/v1/router/routes

æ”¶åˆ°çš„èœå•ï¼š
  âœ… é¦–é¡µ
  âœ… ç³»ç»Ÿç®¡ç†
  âœ… èŒä½ç®¡ç† â† æ˜¾ç¤º
  âŒ ç®€å†ç®¡ç† â† è‡ªåŠ¨éšè—
  âŒ ä¼ä¸šç®¡ç† â† è‡ªåŠ¨éšè—

ç”¨æˆ·ç‚¹å‡»"èŒä½ç®¡ç†"ï¼š
  â†’ Commonç»„ä»¶åŠ è½½
  â†’ route.meta.table_name = "job"
  â†’ è‡ªåŠ¨é€‚é…Jobä¸šåŠ¡
  â†’ æ˜¾ç¤ºèŒä½åˆ—è¡¨
```

### åœºæ™¯2ï¼šå¯åŠ¨Job + Resume

**åç«¯å¯åŠ¨ï¼š**
```bash
âœ… Job Service (8084)
âœ… Resume Service (8085)
âŒ Company Service - æœªå¯åŠ¨
```

**å‰ç«¯è‡ªåŠ¨é€‚é…ï¼š**
```
æ”¶åˆ°çš„èœå•ï¼š
  âœ… é¦–é¡µ
  âœ… ç³»ç»Ÿç®¡ç†
  âœ… èŒä½ç®¡ç† â† æ˜¾ç¤º
  âœ… ç®€å†ç®¡ç† â† æ˜¾ç¤º
  âŒ ä¼ä¸šç®¡ç† â† è‡ªåŠ¨éšè—

Commonç»„ä»¶ï¼š
  /jobs â†’ è‡ªåŠ¨é€‚é…Job
  /resumes â†’ è‡ªåŠ¨é€‚é…Resume
```

### åœºæ™¯3ï¼šå¯åŠ¨æ‰€æœ‰æœåŠ¡

**åç«¯å¯åŠ¨ï¼š**
```bash
âœ… Job Service (8084)
âœ… Resume Service (8085)
âœ… Company Service (8083)
```

**å‰ç«¯è‡ªåŠ¨é€‚é…ï¼š**
```
æ”¶åˆ°çš„èœå•ï¼š
  âœ… é¦–é¡µ
  âœ… ç³»ç»Ÿç®¡ç†
  âœ… èŒä½ç®¡ç† â† æ˜¾ç¤º
  âœ… ç®€å†ç®¡ç† â† æ˜¾ç¤º
  âœ… ä¼ä¸šç®¡ç† â† æ˜¾ç¤º

Commonç»„ä»¶ï¼š
  /jobs â†’ Job
  /resumes â†’ Resume
  /companies â†’ Company
  å®Œå…¨è‡ªé€‚åº”ï¼
```

## ğŸ”§ æŠ€æœ¯å®ç°

### Router Serviceçš„æ™ºèƒ½è¿‡æ»¤ä»£ç 

**å·²å®ç°ï¼š**

```go
// service_discovery.go
type ServiceDiscovery struct {
    client *api.Client
    cache  map[string]bool
}

func (sd *ServiceDiscovery) GetAvailableServices() []string {
    // æŸ¥è¯¢Consul
    services, _, _ := sd.client.Catalog().Services(nil)
    
    // æ£€æŸ¥P2æœåŠ¡å¥åº·çŠ¶æ€
    available := []string{}
    for _, serviceName := range ["job-service", "resume-service", "company-service"] {
        if sd.IsServiceHealthy(serviceName) {
            available = append(available, serviceName)
        }
    }
    
    return available
}

// main.go - getAllRouteConfigs
func getAllRouteConfigs(sqlDB *sql.DB) []RouteConfig {
    // ğŸ¯ æ™ºèƒ½è¿‡æ»¤
    availableServices := serviceDiscovery.GetAvailableServices()
    
    query := `
        SELECT ... FROM route_config
        WHERE is_active = true
        AND service_name = ANY($1)  â† å…³é”®ï¼šåªè¿”å›å¯ç”¨æœåŠ¡çš„è·¯ç”±
    `
    
    rows, _ := sqlDB.Query(query, availableServices)
    
    // å‰ç«¯åªä¼šæ”¶åˆ°"å½“å‰å¯ç”¨"çš„è·¯ç”±
    return routes
}
```

### å‰ç«¯çš„å“åº”

**å‰ç«¯ä»£ç ï¼ˆå·²å­˜åœ¨ï¼‰ï¼š**
```javascript
// vuecmf-web-master/src/service/LayoutService.ts

loadMenu() {
    // è°ƒç”¨Router Service
    const response = await getMenuList()
    
    // Router Serviceå·²ç»è¿‡æ»¤äº†
    // åªè¿”å›å½“å‰å¯ç”¨æœåŠ¡çš„è·¯ç”±
    this.menuList.value = response.data
    
    // æ„å»ºèœå•æ ‘
    this.menuTree.value = this.buildMenuTree(response.data)
    
    // æ³¨å†Œè·¯ç”±
    this.registerRoutes(this.menuTree.value)
    
    // è‡ªåŠ¨é€‚é…ï¼
}
```

**Commonç»„ä»¶ï¼ˆå·²å­˜åœ¨ï¼‰ï¼š**
```vue
<!-- Common.vue -->
<template>
  <!-- é€šç”¨æ¨¡æ¿ï¼Œé€‚é…ä»»ä½•ä¸šåŠ¡ç±»å‹ -->
  è¡¨å: {{ route.meta.table_name }}
  <!-- Job/Resume/Companyéƒ½èƒ½ç”¨ï¼ -->
</template>
```

## âœ… è¿™å°±æ˜¯å®Œæ•´çš„è‡ªé€‚åº”æœºåˆ¶ï¼

### å®Œæ•´æµç¨‹

```
1. ç®¡ç†å‘˜å¯åŠ¨æœåŠ¡
   START_P2=yes ./start-service.sh job
   â†“
2. Consulè®°å½•
   job-service = healthy âœ…
   resume-service = not found âŒ
   company-service = not found âŒ
   â†“
3. å‰ç«¯åŠ è½½èœå•
   GET /api/v1/router/routes
   â†“
4. Router Serviceæ™ºèƒ½è¿‡æ»¤
   â€¢ æŸ¥è¯¢Consul â†’ job-serviceå¯ç”¨
   â€¢ WHERE service_name = 'job-service'
   â€¢ åªè¿”å›Jobçš„è·¯ç”±
   â†“
5. å‰ç«¯æ”¶åˆ°
   åªæœ‰Jobç›¸å…³çš„èœå•æ•°æ®
   â†“
6. å‰ç«¯æ˜¾ç¤º
   âœ… èŒä½ç®¡ç†ï¼ˆæ˜¾ç¤ºï¼‰
   âŒ ç®€å†ç®¡ç†ï¼ˆéšè—ï¼‰
   âŒ ä¼ä¸šç®¡ç†ï¼ˆéšè—ï¼‰
   â†“
7. ç”¨æˆ·ç‚¹å‡»"èŒä½ç®¡ç†"
   â†“
8. Commonç»„ä»¶è‡ªåŠ¨é€‚é…
   table_name = "job"
   åŠ è½½Jobæ•°æ®
   æ˜¾ç¤ºJobåˆ—è¡¨
```

**å®Œå…¨è‡ªåŠ¨ï¼æ— éœ€ä»»ä½•æ‰‹åŠ¨é…ç½®ï¼**

## ğŸ§ª ç«‹å³éªŒè¯

### æµ‹è¯•å‘½ä»¤

```bash
# 1. æ£€æŸ¥å½“å‰æœåŠ¡ç»„åˆ
curl http://localhost:8087/api/v1/router/service-combination | jq .

# é¢„æœŸè¾“å‡ºï¼ˆå½“å‰æ²¡å¯åŠ¨P2æœåŠ¡ï¼‰ï¼š
{
  "data": {
    "combination": "minimal",  // åªæœ‰åŸºç¡€è®¾æ–½
    "available_services": [],
    "total_services": 0
  }
}

# 2. å¯åŠ¨Job Serviceæµ‹è¯•
cd services/business/job
go run main.go &
sleep 5

# 3. å†æ¬¡æ£€æŸ¥
curl http://localhost:8087/api/v1/router/service-combination | jq .

# é¢„æœŸè¾“å‡ºï¼š
{
  "data": {
    "combination": "job_only",  // Job onlyç»„åˆ
    "available_services": ["job-service"],
    "total_services": 1
  }
}

# 4. å‰ç«¯ä¼šè‡ªåŠ¨åªæ˜¾ç¤ºJobèœå•ï¼
```

## ğŸ’ è¿™å°±æ˜¯"æ™ºèƒ½è‡ªé€‚åº”"çš„ä»·å€¼

### å¯¹æ¯”

**ä¼ ç»Ÿæ–¹å¼ï¼š**
```
âŒ ç¡¬ç¼–ç èœå•
âŒ æ‰‹åŠ¨é…ç½®
âŒ ç‚¹å‡»æœªå¯åŠ¨æœåŠ¡ â†’ 404
âŒ ç”¨æˆ·ä½“éªŒå·®
```

**Zerviæ™ºèƒ½æ–¹å¼ï¼š**
```
âœ… Consulè‡ªåŠ¨å‘ç°
âœ… Routeræ™ºèƒ½è¿‡æ»¤
âœ… å‰ç«¯è‡ªåŠ¨é€‚é…
âœ… Commonç»„ä»¶é€šç”¨
âœ… å®Œå…¨è‡ªåŠ¨åŒ–
```

### Commonç»„ä»¶çš„è®¾è®¡ç²¾é«“

```
é€šç”¨ = ä¸å…³å¿ƒå…·ä½“ä¸šåŠ¡ç±»å‹

åªéœ€è¦ï¼š
  â€¢ table_nameï¼ˆä»route.metaè·å–ï¼‰
  â€¢ action_typeï¼ˆä»route.metaè·å–ï¼‰
  â€¢ å…¶ä»–é…ç½®ï¼ˆä»route.metaè·å–ï¼‰

ç»“æœï¼š
  ä¸€ä¸ªç»„ä»¶ï¼Œé€‚é…Job/Resume/Companyæ‰€æœ‰ä¸šåŠ¡ï¼
  è¿™æ‰æ˜¯çœŸæ­£çš„"é€šç”¨ç»„ä»¶"ï¼
```

## ğŸš€ ä¸‹ä¸€æ­¥

1. **é‡å¯Router Service**ï¼ˆå¯ç”¨æ™ºèƒ½è¿‡æ»¤ï¼‰
2. **æµ‹è¯•ä¸åŒçš„æœåŠ¡ç»„åˆ**
3. **éªŒè¯å‰ç«¯èœå•è‡ªåŠ¨å˜åŒ–**
4. **å®Œå–„è‡ªé€‚åº”é€»è¾‘**

è¿™æ‰æ˜¯**çœŸæ­£çš„å¢å¼ºAIä¸­å¤®å¤§è„‘**çš„æ™ºèƒ½åŒ–ä½“ç°ï¼

---

**å®Œæˆæ—¶é—´**: 2025-11-06
**æ ¸å¿ƒä»·å€¼**: å‰ç«¯æ ¹æ®åç«¯æœåŠ¡ç»„åˆè‡ªåŠ¨é€‚é…ï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®ï¼

